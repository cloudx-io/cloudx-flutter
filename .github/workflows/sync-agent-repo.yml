name: Sync Agent Repository

on:
  push:
    branches: [main, develop]
    paths:
      - 'cloudx_flutter_sdk/lib/**/*.dart'
      - '.claude/maintenance/SDK_VERSION.yaml'

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.diff.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check API changes
        id: diff
        run: |
          git diff HEAD^ HEAD -- cloudx_flutter_sdk/lib/ > api_changes.diff
          if [ -s api_changes.diff ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üìù Flutter SDK API changes detected"
            cat api_changes.diff
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No API changes"
          fi

  sync:
    needs: check-changes
    if: needs.check-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clone agent repo
        run: bash scripts/sync_to_agent_repo.sh

      - name: Comment on PR (manual trigger for now)
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è **Flutter SDK API changes detected**\n\nRun: `Use cloudx-flutter-agent-maintainer to sync agent repo`'
            })

      - name: Alert on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üö® **Flutter agent sync failed**\n\nManual sync required. See logs.'
            })
