name: Validate Maintainer Agent

# Runs validation checks on maintainer agent and SDK version tracking
on:
  push:
    branches: [main, develop, 'kainar-*']
    paths:
      - 'cloudx_flutter_sdk/lib/**'
      - '.claude/**'
      - 'scripts/validate_critical_apis.sh'
      - 'cloudx_flutter_sdk/pubspec.yaml'

  pull_request:
    branches: [main, develop]
    paths:
      - 'cloudx_flutter_sdk/lib/**'
      - '.claude/**'
      - 'scripts/validate_critical_apis.sh'
      - 'cloudx_flutter_sdk/pubspec.yaml'

  workflow_dispatch:  # Allow manual trigger

jobs:
  validate:
    name: Validate Maintainer Agent & Version Sync
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check maintainer agent exists
        run: |
          echo "üîç Checking maintainer agent..."
          if [ ! -f .claude/agents/cloudx-flutter-agent-maintainer.md ]; then
            echo "‚ùå ERROR: Maintainer agent not found!"
            exit 1
          fi
          echo "‚úÖ Maintainer agent found"

      - name: Validate SDK_VERSION.yaml sync
        run: |
          echo ""
          echo "üîç Checking SDK version consistency..."
          if [ ! -f .claude/maintenance/SDK_VERSION.yaml ]; then
            echo "‚ùå ERROR: .claude/maintenance/SDK_VERSION.yaml not found!"
            exit 1
          fi

          YAML_VERSION=$(grep "^sdk_version:" .claude/maintenance/SDK_VERSION.yaml | awk '{print $2}' | tr -d '"')
          PUBSPEC_VERSION=$(grep "^version:" cloudx_flutter_sdk/pubspec.yaml | awk '{print $2}' | tr -d '"')

          echo "SDK_VERSION.yaml: $YAML_VERSION"
          echo "pubspec.yaml: $PUBSPEC_VERSION"
          echo ""

          if [ "$YAML_VERSION" != "$PUBSPEC_VERSION" ]; then
            echo "‚ùå Version mismatch detected!"
            echo ""
            echo "The SDK_VERSION.yaml is out of sync with the actual SDK version."
            echo ""
            echo "Action required:"
            echo "1. Update sdk_version in .claude/maintenance/SDK_VERSION.yaml to: $PUBSPEC_VERSION"
            echo "2. Run maintainer agent to sync agent repo"
            echo "3. Update agents_last_updated field"
            echo ""
            exit 1
          fi

          echo "‚úÖ SDK version matches: $YAML_VERSION"

      - name: Validate maintainer agent documentation
        run: |
          echo ""
          echo "üîç Validating maintainer agent documentation..."

          # Check for required sections
          if ! grep -q "Cross-Repository Sync Mode" .claude/agents/cloudx-flutter-agent-maintainer.md; then
            echo "‚ùå Missing 'Cross-Repository Sync Mode' section"
            exit 1
          fi

          if ! grep -q "Environment Variables" .claude/agents/cloudx-flutter-agent-maintainer.md; then
            echo "‚ùå Missing 'Environment Variables' section"
            exit 1
          fi

          echo "‚úÖ Maintainer agent documentation valid"

      - name: Check for API changes requiring sync
        run: |
          echo ""
          echo "üîç Checking for API changes..."

          # Only run on PRs
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "‚ÑπÔ∏è  Skipping (not a PR)"
            exit 0
          fi

          # Check if API files changed
          git fetch origin ${{ github.base_ref }}
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "cloudx_flutter_sdk/lib/"; then
            echo "‚ö†Ô∏è  API changes detected in this PR"
            echo ""
            echo "After merging, run:"
            echo "Use cloudx-flutter-agent-maintainer to sync agent repo with SDK changes"
            echo ""
          else
            echo "‚úÖ No API changes"
          fi

      - name: Validation summary
        if: success()
        run: |
          echo ""
          echo "================================"
          echo "‚úÖ All validation checks passed!"
          echo "================================"
          echo ""
          echo "What was validated:"
          echo "- Maintainer agent file exists"
          echo "- SDK version sync (YAML ‚Üî pubspec.yaml)"
          echo "- Maintainer agent documentation structure"
          echo "- API change detection (PR only)"
          echo ""
